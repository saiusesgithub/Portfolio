---
import { siteData } from '../data/portfolio';

const navLinks = [
  { id: '01', name: 'About', href: '#about' },
  { id: '02', name: 'Skills', href: '#skills' },
  { id: '03', name: 'Experience', href: '#experience' },
];

// Split name into individual characters for slot machine animation
const nameChars = siteData.name.split('');
// Split into words - first word default color, second word orange
const nameParts = siteData.name.split(' ');
const firstWordEnd = nameParts[0].length; // index where first word ends
const isSecondWord = nameChars.map((char, i) => {
  if (char === ' ') return false;
  return i > firstWordEnd;
});
---

<nav id="main-nav" class="fixed top-0 left-0 w-full z-[200] bg-concrete border-beam-b">
  <div id="nav-inner" class="flex flex-col lg:flex-row justify-between lg:items-stretch h-auto">
    <!-- Left: Logo -->
    <div class="flex items-center justify-between p-4 lg:p-0 lg:w-1/4 lg:border-beam-r bg-concrete relative z-20 h-full">
      <a href="#" class="block pl-4 lg:pl-6">
        <span
          id="nav-name"
          class="inline-flex text-2xl lg:text-3xl font-extrabold tracking-tight uppercase whitespace-nowrap"
        >
          {nameChars.map((char, i) => (
            <span
              class={`nav-char inline-block relative overflow-hidden ${isSecondWord[i] ? 'text-safety-orange' : ''}`}
              data-index={String(i)}
              data-char={char}
              style="height: 1.2em; line-height: 1.2em;"
            >
              <span class="nav-char-inner inline-block">{char === ' ' ? '\u00A0' : char}</span>
            </span>
          ))}
        </span>
      </a>
      <!-- Mobile Menu Icon -->
      <button class="lg:hidden p-2 border-beam bg-white">
        <i data-lucide="menu" class="w-6 h-6"></i>
      </button>
    </div>

    <!-- Right: Links -->
    <div class="hidden lg:flex flex-1 justify-end items-center font-tech text-xs tracking-widest uppercase divide-x-2 divide-black">
      {navLinks.map(link => (
        <a 
          href={link.href} 
          class="cursor-target nav-link h-full flex items-center justify-center gap-0 px-8 hover:bg-black hover:text-white transition-colors duration-0 border-l-2 border-black group"
          data-section={link.href.replace('#', '')}
        >
          <span class="nav-bracket opacity-0 -translate-x-3 group-hover:opacity-100 group-hover:translate-x-0 transition-all duration-200 font-bold">[</span>
          <span class="inline-block px-1 group-hover:translate-x-0 transition-transform duration-200">{link.id} {link.name}</span>
          <span class="nav-bracket opacity-0 translate-x-3 group-hover:opacity-100 group-hover:translate-x-0 transition-all duration-200 font-bold">]</span>
        </a>
      ))}
      <a 
        href="#contact" 
        class="cursor-target nav-link h-full flex items-center justify-center gap-0 px-8 bg-safety-orange text-white hover:bg-black transition-colors duration-0 font-bold border-l-2 border-black group"
        data-section="contact"
      >
        <span class="nav-bracket opacity-0 -translate-x-3 group-hover:opacity-100 group-hover:translate-x-0 transition-all duration-200">[</span>
        <span class="inline-block px-1 group-hover:translate-x-0 transition-transform duration-200">04 Contact</span>
        <span class="nav-bracket opacity-0 translate-x-3 group-hover:opacity-100 group-hover:translate-x-0 transition-all duration-200">]</span>
      </a>
    </div>
  </div>
</nav>

<!-- Spacer for Fixed Nav -->
<div id="nav-spacer" class="w-full"></div>

<style is:global>
  /* Navbar height with transition for shrink effect */
  @media (min-width: 1024px) {
    #nav-inner {
      height: 5rem;
      transition: height 0.3s ease;
    }
    #main-nav.nav-shrunk #nav-inner {
      height: 3.5rem;
    }
  }
  
  /* Spacer height matches navbar */
  #nav-spacer {
    height: 5rem;
    transition: height 0.3s ease;
  }

  /* Active section indicator — orange bottom accent */
  .nav-link.nav-active {
    box-shadow: inset 0 -3px 0 var(--safety-orange);
  }
  
  /* Override active on the orange contact button */
  .nav-link.nav-active.bg-safety-orange {
    box-shadow: inset 0 -3px 0 #000;
  }
</style>

<script>
  import { gsap } from 'gsap';

  function initNavbar() {
    // ========================================
    // 1. LETTER SLOT MACHINE — Name Animation
    // ========================================
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
    const charEls = document.querySelectorAll<HTMLElement>('.nav-char');
    
    function slotMachine(triggerChars: NodeListOf<HTMLElement> | HTMLElement[], onComplete?: () => void) {
      const totalChars = triggerChars.length;
      let completed = 0;

      triggerChars.forEach((charEl) => {
        const inner = charEl.querySelector('.nav-char-inner') as HTMLElement;
        if (!inner) return;

        const targetChar = charEl.dataset.char || '';
        const idx = parseInt(charEl.dataset.index || '0');
        
        // Skip spaces
        if (targetChar === ' ') {
          inner.textContent = '\u00A0';
          completed++;
          if (completed >= totalChars && onComplete) onComplete();
          return;
        }

        // Number of "spins" before landing — earlier letters stop sooner
        const totalSpins = 8 + idx * 3;
        let spinCount = 0;

        const spinInterval = setInterval(() => {
          // Roll through random characters
          inner.textContent = chars[Math.floor(Math.random() * chars.length)];
          
          // Subtle vertical jitter for slot machine feel  
          gsap.set(inner, { y: (Math.random() - 0.5) * 4 });
          
          spinCount++;
          
          if (spinCount >= totalSpins) {
            clearInterval(spinInterval);
            // Land on the correct character with a snap
            inner.textContent = targetChar;
            gsap.to(inner, {
              y: 0,
              duration: 0.15,
              ease: 'back.out(3)',
            });
            completed++;
            if (completed >= totalChars && onComplete) onComplete();
          }
        }, 40); // 40ms per spin frame
      });
    }

    if (charEls.length) {
      // Wait for grid overlay to be cleared, then play slot machine
      // (the name is hidden behind orange boxes until user clears them)
      const waitForGridClear = () => {
        if (!document.getElementById('grid-overlay')) {
          slotMachine(charEls);
        } else {
          setTimeout(waitForGridClear, 300);
        }
      };
      waitForGridClear();

      // Re-trigger on hover
      const nameEl = document.getElementById('nav-name');
      if (nameEl) {
        nameEl.addEventListener('mouseenter', () => {
          slotMachine(charEls);
        });
      }
    }

    // ========================================
    // 2. ACTIVE SECTION HIGHLIGHT
    // ========================================
    const sections = document.querySelectorAll('section[id]');
    const navLinks = document.querySelectorAll('.nav-link[data-section]');

    if (sections.length && navLinks.length) {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const id = entry.target.id;
            navLinks.forEach(link => {
              const el = link as HTMLElement;
              if (el.dataset.section === id) {
                el.classList.add('nav-active');
              } else {
                el.classList.remove('nav-active');
              }
            });
          }
        });
      }, {
        rootMargin: '-20% 0px -60% 0px',
        threshold: 0,
      });

      sections.forEach(section => observer.observe(section));
    }

    // ========================================
    // 3. NAVBAR SHRINK ON SCROLL
    // ========================================
    const nav = document.getElementById('main-nav');
    const spacer = document.getElementById('nav-spacer');
    
    if (nav) {
      let shrunk = false;
      window.addEventListener('scroll', () => {
        const shouldShrink = window.scrollY > 150;
        if (shouldShrink !== shrunk) {
          shrunk = shouldShrink;
          if (shrunk) {
            nav.classList.add('nav-shrunk');
            if (spacer) spacer.style.height = '3.5rem';
          } else {
            nav.classList.remove('nav-shrunk');
            if (spacer) spacer.style.height = '';
          }
        }
      }, { passive: true });
    }
  }

  // Ensure DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initNavbar);
  } else {
    initNavbar();
  }
</script>
